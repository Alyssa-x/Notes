# Nginx

## Nginx是什么？

- Nginx是一款自由的，开源的，高性能的轻量级HTTP服务器和反向代理服务器。采用事件驱动的异步非阻塞处理方式框架，让其具有极好的IO性能，常用于服务端的反向代理和负载均衡。

## Nginx的出现

Nginx是一款web服务器，那么什么是web服务器？

- web服务器： 负责处理和响应用户请求，一般也称http服务器，如Apache，IIS，Nginx
- 应用服务器： 存放和运行系统程序的服务器，负责处理程序中的业务逻辑，如Tomcat，Weblogic，Jboss（如今大部分应用服务器也包含了web服务器的功能）

Apache作为老牌的世界第一大服务器，发展历史悠久，稳定，开源，且跨平台。但是由于不支持高并发，在Apache上运行数以万计的并发访问时，服务器会消耗大量内存。操作系统进行线程与进程之间的切换时，也会消耗大量的CPU资源，导致HTTP请求的平均响应速度降低。

这就导致Apache不能成为高性能轻量级并发服务器。此时，Nginx服务器就产生了。

Nginx的优点：

- 基于事件驱动架构，使其可以支持数以百万计的TCP连接
- 高度的模块化和自由软件许可证使第三方模块层出不穷
- Nginx是一个跨平台服务器，可以运行在Linux，Windows，FreeBSD，Solaris，AIX和Mac OS等操作系统
- 稳定性高

## 关于代理

被代理的角色通过代理来访问目标角色完成一些操作。例如，潮人在时尚买手店买到潮鞋，潮人-> 被代理的角色，买手店 -> 代理，潮鞋 -> 目标角色

### 正向代理

当我们在国内想访问一些国外网站，无法直接访问时，需要去请求代理服务器，此时代理服务器去访问国外网站，然后将访问到的数据传给我们。这就是正向代理。

正向代理就是代理客户端，代客户端发出请求。目标服务器并不知道真实的客户端信息，但客户端非常明确想要访问的服务器地址。

#### 用途

- 访问原来无法访问的资源
- 做缓存，加速访问资源
- 对客户端访问授权，上网进行认证
- 代理可以记录用户访问记录（上网行为管理），对外隐藏用户信息

### 反向代理

淘宝网每天访问人数过多，单个服务器根本不能满足如此大的访问量，于是采用分布式部署，即通过多台服务器来解决访问人数限制的问题。客户端给服务端发送请求，经过代理后给任意一个服务端来处理，返回数据。

反向代理就是代理服务端，代服务端来接受请求。客户端并不知道访问的是哪个服务器，也不知道访问的是代理，反向代理对外隐藏了服务器的信息。

#### 用途

- 保护内网的安全，将反向代理作为公网访问地址，web服务器是内网
- 负载均衡，通过反向代理服务器来优化网站的负载
- 实现跨域

CDN就是反向代理经典的应用场景之一。

## 负载均衡

将服务器收到的请求按照规则分发的过程，称为负载均衡。

有硬件负载和软件负载两种。硬负载如F5负载均衡，价格昂贵；大部分采用软件负载均衡，即利用现有技术结合主机硬件实现的一种消息队列分发机制。

Nginx支持的负载均衡调度算法有：

1. **weight轮询**（默认，常用，具有HA功效！）：接收到的请求按照权重分配到不同的后端服务器，即使在使用过程中，某一台后端服务器宕机，Nginx会自动将该服务器剔除出队列，请求受理情况不会受到任何影响。 这种方式下，可以给不同的后端服务器设置一个权重值(weight)，用于调整不同的服务器上请求的分配率；权重数据越大，被分配到请求的几率越大；该权重值，主要是针对实际工作环境中不同的后端服务器硬件配置进行调整的。
2. **ip_hash**（常用）：每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，这也在一定程度上解决了集群部署环境下session共享的问题。
3. **fair**：智能调整调度算法，动态的根据后端服务器的请求处理到响应的时间进行均衡分配，响应时间短处理效率高的服务器分配到请求的概率高，响应时间长处理效率低的服务器分配到的请求少；结合了前两者的优点的一种调度算法。但是需要注意的是Nginx默认不支持fair算法，如果要使用这种调度算法，请安装upstream_fair模块。
4. **url_hash**：按照访问的url的hash结果分配请求，每个请求的url会指向后端固定的某个服务器，可以在Nginx作为静态服务器的情况下提高缓存效率。同样要注意Nginx默认不支持这种调度算法，要使用的话需要安装Nginx的hash软件包。





